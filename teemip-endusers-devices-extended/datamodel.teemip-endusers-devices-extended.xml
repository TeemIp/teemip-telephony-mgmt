<?xml version="1.0" encoding="UTF-8"?>
<itop_design xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" version="3.2" load="strict">
    <constants>
        <constant id="DEVICES_WITH_SIMCARD" xsi:type="string" _delta="define">MobilePhone,NetworkDevice,Peripheral,PC,Tablet</constant>
    </constants>
    <classes>
        <class id="SimCard" _delta="define">
            <parent>PhysicalDevice</parent>
            <properties>
                <category>bizmodel,searchable,pnmgmt</category>
                <abstract>false</abstract>
                <key_type>autoincrement</key_type>
                <db_table>simcard</db_table>
                <db_key_field>id</db_key_field>
                <db_final_class_field>finalclass</db_final_class_field>
                <naming>
                    <attributes>
                        <attribute id="name"/>
                    </attributes>
                </naming>
                <style>
                    <icon>asset/img/icons8-sim-card.svg</icon>
                </style>
                <order>
                    <columns>
                        <column id="name" ascending="true"/>
                    </columns>
                </order>
                <reconciliation>
                    <attributes>
                        <attribute id="name"/>
                        <attribute id="org_id"/>
                        <attribute id="organization_name"/>
                    </attributes>
                </reconciliation>
                <icon>images/sim.png</icon>
            </properties>
            <fields>
                <field id="format" xsi:type="AttributeEnum">
                    <sql>format</sql>
                    <sort_type>rank</sort_type>
                    <values>
                        <value id="full">
                            <code>full</code>
                            <rank>10</rank>
                        </value>
                        <value id="mini">
                            <code>mini</code>
                            <rank>20</rank>
                        </value>
                        <value id="micro">
                            <code>micro</code>
                            <rank>30</rank>
                        </value>
                        <value id="nano">
                            <code>nano</code>
                            <rank>40</rank>
                        </value>
                        <value id="esim">
                            <code>esim</code>
                            <rank>50</rank>
                        </value>
                        <value id="full_to_micro">
                            <code>full_to_micro</code>
                            <rank>60</rank>
                        </value>
                        <value id="full_to_nano">
                            <code>full_to_nano</code>
                            <rank>70</rank>
                        </value>
                        <value id="micro_to_nano">
                            <code>micro_to_nano</code>
                            <rank>80</rank>
                        </value>
                    </values>
                    <default_value>mini</default_value>
                    <is_null_allowed>true</is_null_allowed>
                    <display_style>list</display_style>
                </field>
                <field id="iccid" xsi:type="AttributeString">
                    <sql>iccid</sql>
                    <default_value>89</default_value>
                    <is_null_allowed>false</is_null_allowed>
                    <validation_pattern>^89\d{17,18}$|^\d{13}$</validation_pattern>
                </field>
                <field id="carrier_id" xsi:type="AttributeExternalKey">
                    <sql>carrier_id</sql>
                    <target_class>Organization</target_class>
                    <is_null_allowed>true</is_null_allowed>
                    <on_target_delete>DEL_MANUAL</on_target_delete>
                </field>
                <field id="phonenumber_id" xsi:type="AttributeExternalKey">
                    <sql>phonenumber_id</sql>
                    <target_class>PhoneNumber</target_class>
                    <filter><![CDATA[SELECT PhoneNumber AS p WHERE p.org_id = :this->org_id]]></filter>
                    <dependencies>
                        <attribute id="org_id"/>
                    </dependencies>
                    <is_null_allowed>false</is_null_allowed>
                    <on_target_delete>DEL_MANUAL</on_target_delete>
                    <jointype/>
                </field>
                <field id="phonenumber" xsi:type="AttributeExternalField">
                    <extkey_attcode>phonenumber_id</extkey_attcode>
                    <target_attcode>number</target_attcode>
                </field>
                <field id="pin" xsi:type="AttributeString">
                    <sql>pin</sql>
                    <is_null_allowed>true</is_null_allowed>
                    <default_value/>
                    <validation_pattern>^\d{4,8}$</validation_pattern>
                </field>
                <field id="pin2" xsi:type="AttributeString">
                    <sql>pin2</sql>
                    <is_null_allowed>true</is_null_allowed>
                    <default_value/>
                    <validation_pattern>^\d{4,8}$</validation_pattern>
                </field>
                <field id="puk" xsi:type="AttributeString">
                    <sql>puk</sql>
                    <is_null_allowed>true</is_null_allowed>
                    <default_value/>
                    <validation_pattern>^\d{8}$</validation_pattern>
                </field>
                <field id="puk2" xsi:type="AttributeString">
                    <sql>puk2</sql>
                    <is_null_allowed>true</is_null_allowed>
                    <default_value/>
                    <validation_pattern>^\d{8}$</validation_pattern>
                </field>
                <field id="contact_id" xsi:type="AttributeExternalKey">
                    <sql>contact_id</sql>
                    <target_class>Contact</target_class>
                    <filter><![CDATA[SELECT Contact AS c WHERE c.org_id = :this->org_id]]></filter>
                    <dependencies>
                        <attribute id="org_id"/>
                    </dependencies>
                    <is_null_allowed>true</is_null_allowed>
                    <allow_target_creation>true</allow_target_creation>
                    <on_target_delete>DEL_AUTO</on_target_delete>
                </field>
                <field id="physicaldevice_id" xsi:type="AttributeExternalKey">
                    <sql>physicaldevice_id</sql>
                    <target_class>PhysicalDevice</target_class>
                    <filter/>
                    <dependencies>
                        <attribute id="org_id"/>
                    </dependencies>
                    <is_null_allowed>true</is_null_allowed>
                    <allow_target_creation>true</allow_target_creation>
                    <on_target_delete>DEL_AUTO</on_target_delete>
                </field>
                <field id="physicaldevice_name" xsi:type="AttributeExternalField">
                    <extkey_attcode>physicaldevice_id</extkey_attcode>
                    <target_attcode>name</target_attcode>
                </field>
                <field id="physicalinterface_id" xsi:type="AttributeExternalKey">
                    <sql>physicalinterface_id</sql>
                    <target_class>PhysicalInterface</target_class>
                    <filter>SELECT PhysicalInterface AS pi WHERE pi.connectableci_id = :this->physicaldevice_id</filter>
                    <dependencies>
                        <attribute id="physicaldevice_id"/>
                    </dependencies>
                    <is_null_allowed>true</is_null_allowed>
                    <allow_target_creation>true</allow_target_creation>
                    <on_target_delete>DEL_AUTO</on_target_delete>
                </field>
                <field id="physicalinterface_name" xsi:type="AttributeExternalField">
                    <extkey_attcode>physicalinterface_id</extkey_attcode>
                    <target_attcode>name</target_attcode>
                </field>
            </fields>
            <event_listeners>
                <event_listener id="OnSimCardCheckToWriteRequestedByEndUsersDevicesExtendedMgmt">
                    <event>EVENT_DB_CHECK_TO_WRITE</event>
                    <callback>OnSimCardCheckToWriteRequestedByEndUsersDevicesExtendedMgmt</callback>
                    <rank>100</rank>
                </event_listener>
                <event_listener id="OnSimCardAfterWriteRequestedByEndUsersDevicesExtendedMgmt">
                    <event>EVENT_DB_AFTER_WRITE</event>
                    <callback>OnSimCardAfterWriteRequestedByEndUsersDevicesExtendedMgmt</callback>
                    <rank>100</rank>
                </event_listener>
                <event_listener id="OnSimCardAfterDeleteRequestedByEndUsersDevicesExtendedMgmt">
                    <event>EVENT_DB_AFTER_DELETE</event>
                    <callback>OnSimCardAfterDeleteRequestedByEndUsersDevicesExtendedMgmt</callback>
                    <rank>100</rank>
                </event_listener>
            </event_listeners>
            <methods>
                <method id="SetSimCardOnPhysicalDevice">
                    <comment/>
                    <static>false</static>
                    <access>private</access>
                    <type>custom</type>
                    <code><![CDATA[    public function SetSimCardOnPhysicalDevice($iPhysicalDeviceId)
    {
			if (($iPhysicalDeviceId > 0) && in_array('simcard_id', MetaModel::GetAttributesList('PhysicalDevice'))) {
			    $sDevicesWithSimCard = "'".str_replace(',', "','", DEVICES_WITH_SIMCARD)."'";
				$sOQL = "SELECT PhysicalDevice AS d WHERE d.id = $iPhysicalDeviceId AND d.finalclass IN ($sDevicesWithSimCard)";
       			$oPhysicalDeviceSet = new CMDBObjectSet(DBObjectSearch::FromOQL($sOQL));
				if ($oPhysicalDevice = $oPhysicalDeviceSet->Fetch()) {
					$oPhysicalDevice->Set('simcard_id', $this->GetKey());
					$oPhysicalDevice->DBUpdate();
				}
			}
    }]]></code>
                </method>
                <method id="ResetSimCardOnPhysicalDevice">
                    <comment/>
                    <static>false</static>
                    <access>private</access>
                    <type>custom</type>
                    <code><![CDATA[    public function ResetSimCardOnPhysicalDevice($iPhysicalDeviceId)
    {
			if (($iPhysicalDeviceId > 0) && in_array('simcard_id', MetaModel::GetAttributesList('PhysicalDevice'))) {
			    $sDevicesWithSimCard = "'".str_replace(',', "','", DEVICES_WITH_SIMCARD)."'";
				$sOQL = "SELECT PhysicalDevice AS d WHERE d.id = $iPhysicalDeviceId AND d.finalclass IN ($sDevicesWithSimCard)";
       			$oPhysicalDeviceSet = new CMDBObjectSet(DBObjectSearch::FromOQL($sOQL));
				if ($oPhysicalDevice = $oPhysicalDeviceSet->Fetch()) {
				    if ($oPhysicalDevice->Get('simcard_id') == $this->GetKey()) {
					    $oPhysicalDevice->Set('simcard_id', 0);
					    $oPhysicalDevice->DBUpdate();
					}
				}
			}
    }]]></code>
                </method>
                <method id="OnSimCardCheckToWriteRequestedByEndUsersDevicesExtendedMgmt">
                    <comment/>
                    <static>false</static>
                    <access>public</access>
                    <type>EventListener</type>
                    <code><![CDATA[    public function OnSimCardCheckToWriteRequestedByEndUsersDevicesExtendedMgmt(Combodo\iTop\Service\Events\EventData $oEventData)
    {
        $iPhysicalDeviceId = $this->Get('physicaldevice_id');
        if ($iPhysicalDeviceId > 0) {
            $oPhysicalDevice = MetaModel::GetObject('PhysicalDevice', $iPhysicalDeviceId);
            if ($oPhysicalDevice) {
                // Check that the right class of physical device is selected, if any
	            $aDevicesWithSimCard = explode(',', DEVICES_WITH_SIMCARD);
                if (!in_array(get_class($oPhysicalDevice), $aDevicesWithSimCard)) {
                    $this->AddCheckIssue('UI:EndusersDevicesExtended:Action:New:SimCard:WrongPhysicalDevice');
                    return;
                }

                // Check that the format of the simcard is compatible with what the physical device can host.
                if (in_array('simcard_format', MetaModel::GetAttributesList('PhysicalDevice'))) {
                    $sTargetFormat = $oPhysicalDevice->Get('simcard_format');
                    $sSimCardFormat = $this->Get('format');
                    switch ($sSimCardFormat) {
                        case 'full':
                        case 'mini':
                        case 'micro':
                        case 'nano':
                        case 'esim':
                            if ($sTargetFormat != $sSimCardFormat) {
                                $this->AddCheckIssue('UI:EndusersDevicesExtended:Action:New:SimCard:IncompatibleSIMs');
                            }
                            break;

                        case 'full_to_micro':
                            if (!in_array($sTargetFormat, ['full', 'micro'])) {
                                $this->AddCheckIssue('UI:EndusersDevicesExtended:Action:New:SimCard:IncompatibleSIMs');
                            }
                            break;

                        case 'full_to_nano':
                            if (!in_array($sTargetFormat, ['full', 'nano'])) {
                                $this->AddCheckIssue('UI:EndusersDevicesExtended:Action:New:SimCard:IncompatibleSIMs');
                            }
                            break;

                        case 'micro_to_nano':
                            if (!in_array($sTargetFormat, ['micro', 'nano'])) {
                                $this->AddCheckIssue('UI:EndusersDevicesExtended:Action:New:SimCard:IncompatibleSIMs');
                            }
                            break;

                        default:
                            break;
                    }
                }
            }
        }
    }]]></code>
                </method>
                <method id="OnSimCardAfterWriteRequestedByEndUsersDevicesExtendedMgmt">
                    <comment/>
                    <static>false</static>
                    <access>public</access>
                    <type>EventListener</type>
                    <code><![CDATA[    public function OnSimCardAfterWriteRequestedByEndUsersDevicesExtendedMgmt(Combodo\iTop\Service\Events\EventData $oEventData)
    {
        $aEventData = $oEventData->GetEventData();
        if ($aEventData['is_new']) {
        	// We are in the AfterInsert situation
			$this->SetSimCardOnPhysicalDevice($this->Get('physicaldevice_id'));
 		} else {
		    // We are in the AfterUpdate situation
			$aChanges = $this->ListPreviousValuesForUpdatedAttributes();
			if (array_key_exists('physicaldevice_id', $aChanges)) {
				$this->ResetSimCardOnPhysicalDevice($aChanges['physicaldevice_id']);
    			$this->SetSimCardOnPhysicalDevice($this->Get('physicaldevice_id'));
			}
        }
    }]]></code>
                </method>
                <method id="OnSimCardAfterDeleteRequestedByEndUsersDevicesExtendedMgmt">
                    <comment/>
                    <static>false</static>
                    <access>public</access>
                    <type>EventListener</type>
                    <code><![CDATA[    public function OnSimCardAfterDeleteRequestedByEndUsersDevicesExtendedMgmt(Combodo\iTop\Service\Events\EventData $oEventData)
    {
		$this->ResetSimCardOnPhysicalDevice($this->Get('physicaldevice_id'));
    }]]></code>
                </method>
            </methods>
            <relations>
                <relation id="impacts">
                    <neighbours>
                        <neighbour id="physicalinterface">
                            <attribute>physicalinterface_id</attribute>
                        </neighbour>
                    </neighbours>
                </relation>
            </relations>
            <presentation>
                <details>
                    <items>
                        <item id="col:col1">
                            <rank>10</rank>
                            <items>
                                <item id="fieldset:SimCard:baseinfo">
                                    <rank>10</rank>
                                    <items>
                                        <item id="name">
                                            <rank>10</rank>
                                        </item>
                                        <item id="org_id">
                                            <rank>20</rank>
                                        </item>
                                        <item id="status">
                                            <rank>30</rank>
                                        </item>
                                        <item id="business_criticity">
                                            <rank>40</rank>
                                        </item>
                                    </items>
                                </item>
                                <item id="fieldset:SimCard:techinfo">
                                    <rank>20</rank>
                                    <items>
                                        <item id="iccid">
                                            <rank>10</rank>
                                        </item>
                                        <item id="format">
                                            <rank>20</rank>
                                        </item>
                                        <item id="pin">
                                            <rank>30</rank>
                                        </item>
                                        <item id="pin2">
                                            <rank>40</rank>
                                        </item>
                                        <item id="puk">
                                            <rank>50</rank>
                                        </item>
                                        <item id="puk2">
                                            <rank>60</rank>
                                        </item>
                                        <item id="asset_number">
                                            <rank>70</rank>
                                        </item>
                                    </items>
                                </item>
                            </items>
                        </item>
                        <item id="col:col2">
                            <rank>20</rank>
                            <items>
                                <item id="fieldset:SimCard:date">
                                    <rank>10</rank>
                                    <items>
                                        <item id="move2production">
                                            <rank>10</rank>
                                        </item>
                                        <item id="purchase_date">
                                            <rank>20</rank>
                                        </item>
                                    </items>
                                </item>
                                <item id="fieldset:SimCard:otherinfo">
                                    <rank>20</rank>
                                    <items>
                                        <item id="description">
                                            <rank>10</rank>
                                        </item>
                                        <item id="carrier_id">
                                            <rank>20</rank>
                                        </item>
                                        <item id="phonenumber_id">
                                            <rank>30</rank>
                                        </item>
                                        <item id="contact_id">
                                            <rank>40</rank>
                                        </item>
                                        <item id="physicaldevice_id">
                                            <rank>50</rank>
                                        </item>
                                        <item id="physicalinterface_id">
                                            <rank>60</rank>
                                        </item>
                                    </items>
                                </item>
                            </items>
                        </item>
                        <item id="contacts_list">
                            <rank>30</rank>
                        </item>
                        <item id="documents_list">
                            <rank>30</rank>
                        </item>
                    </items>
                </details>
                <default_search>
                    <items>
                        <item id="name">
                            <rank>10</rank>
                        </item>
                        <item id="org_id">
                            <rank>20</rank>
                        </item>
                        <item id="status">
                            <rank>30</rank>
                        </item>
                        <item id="iccid">
                            <rank>40</rank>
                        </item>
                        <item id="phonenumber_id">
                            <rank>50</rank>
                        </item>
                        <item id="contact_id">
                            <rank>60</rank>
                        </item>
                    </items>
                </default_search>
                <search>
                    <items>
                        <item id="name">
                            <rank>10</rank>
                        </item>
                        <item id="org_id">
                            <rank>20</rank>
                        </item>
                        <item id="status">
                            <rank>30</rank>
                        </item>
                        <item id="iccid">
                            <rank>40</rank>
                        </item>
                        <item id="phonenumber_id">
                            <rank>50</rank>
                        </item>
                        <item id="contact_id">
                            <rank>60</rank>
                        </item>
                    </items>
                </search>
                <list>
                    <items>
                        <item id="org_id">
                            <rank>10</rank>
                        </item>
                        <item id="status">
                            <rank>20</rank>
                        </item>
                        <item id="iccid">
                            <rank>30</rank>
                        </item>
                        <item id="phonenumber_id">
                            <rank>40</rank>
                        </item>
                        <item id="contact_id">
                            <rank>50</rank>
                        </item>
                    </items>
                </list>
                <summary>
                    <items>
                        <item id="name">
                            <rank>10</rank>
                        </item>
                        <item id="iccid">
                            <rank>20</rank>
                        </item>
                        <item id="phonenumber_id">
                            <rank>30</rank>
                        </item>
                        <item id="contact_id">
                            <rank>40</rank>
                        </item>
                        <item id="physicaldevice_id">
                            <rank>50</rank>
                        </item>
                    </items>
                </summary>
            </presentation>
        </class>
        <class id="TelephonyCI" _delta="must_exist">
            <fields>
                <field id="phonenumber_id" xsi:type="AttributeExternalKey" _delta="define">
                    <sql>phonenumber_id</sql>
                    <target_class>PhoneNumber</target_class>
                    <filter><![CDATA[SELECT PhoneNumber AS p WHERE p.org_id = :this->org_id]]></filter>
                    <dependencies>
                        <attribute id="org_id"/>
                    </dependencies>
                    <is_null_allowed>false</is_null_allowed>
                    <on_target_delete>DEL_MANUAL</on_target_delete>
                    <jointype/>
                </field>
                <field id="phonenumber" xsi:type="AttributeExternalField" _delta="redefine">
                    <extkey_attcode>phonenumber_id</extkey_attcode>
                    <target_attcode>number</target_attcode>
                </field>
            </fields>
            <presentation>
                <details>
                    <items>
                        <item id="phonenumber" _delta="delete"/>
                        <item id="phonenumber_id" _delta="define">
                            <rank>80</rank>
                        </item>
                    </items>
                </details>
                <search>
                    <items>
                        <item id="phonenumber" _delta="delete"/>
                        <item id="phonenumber_id" _delta="define">
                            <rank>80</rank>
                        </item>
                    </items>
                </search>
                <list>
                    <items>
                        <item id="phonenumber" _delta="delete"/>
                        <item id="phonenumber_id" _delta="define">
                            <rank>60</rank>
                        </item>
                    </items>
                </list>
            </presentation>
        </class>
        <class id="Phone" _delta="must_exist" >
            <presentation>
                <details _delta="redefine">
                    <items>
                        <item id="col:col1">
                            <rank>10</rank>
                            <items>
                                <item id="fieldset:TelephonyCI:baseinfo">
                                    <rank>10</rank>
                                    <items>
                                        <item id="name">
                                            <rank>10</rank>
                                        </item>
                                        <item id="org_id">
                                            <rank>20</rank>
                                        </item>
                                        <item id="status">
                                            <rank>30</rank>
                                        </item>
                                        <item id="phonenumber_id">
                                            <rank>40</rank>
                                        </item>
                                        <item id="business_criticity">
                                            <rank>50</rank>
                                        </item>
                                        <item id="location_id">
                                            <rank>60</rank>
                                        </item>
                                        <item id="description">
                                            <rank>70</rank>
                                        </item>
                                    </items>
                                </item>
                                <item id="fieldset:TelephonyCI:hwinfo">
                                    <rank>20</rank>
                                    <items>
                                        <item id="brand_id">
                                            <rank>10</rank>
                                        </item>
                                        <item id="model_id">
                                            <rank>20</rank>
                                        </item>
                                        <item id="serialnumber">
                                            <rank>30</rank>
                                        </item>
                                        <item id="asset_number">
                                            <rank>40</rank>
                                        </item>
                                    </items>
                                </item>
                            </items>
                        </item>
                        <item id="col:col2">
                            <rank>20</rank>
                            <items>
                                <item id="fieldset:TelephonyCI:date">
                                    <rank>10</rank>
                                    <items>
                                        <item id="move2production">
                                            <rank>10</rank>
                                        </item>
                                        <item id="purchase_date">
                                            <rank>20</rank>
                                        </item>
                                        <item id="end_of_warranty">
                                            <rank>30</rank>
                                        </item>
                                    </items>
                                </item>
                            </items>
                        </item>
                        <item id="contacts_list">
                            <rank>30</rank>
                        </item>
                        <item id="documents_list">
                            <rank>30</rank>
                        </item>
                    </items>
                </details>
                <search _delta="must_exist">
                    <items>
                        <item id="phonenumber" _delta="delete"/>
                        <item id="phonenumber_id" _delta="define">
                            <rank>80</rank>
                        </item>
                    </items>
                </search>
                <list _delta="must_exist">
                    <items>
                        <item id="phonenumber" _delta="delete"/>
                        <item id="phonenumber_id" _delta="define">
                            <rank>60</rank>
                        </item>
                    </items>
                </list>
                <summary _delta="must_exist">
                    <items>
                        <item id="phonenumber" _delta="delete"/>
                        <item id="phonenumber_id" _delta="define">
                            <rank>80</rank>
                        </item>
                    </items>
                </summary>
            </presentation>
        </class>
        <class id="MobilePhone" _delta="must_exist">
            <fields>
                <field id="simcard_format" xsi:type="AttributeEnum" _delta="define">
                    <sql>simcard_format</sql>
                    <sort_type>rank</sort_type>
                    <values>
                        <value id="full">
                            <code>full</code>
                            <rank>10</rank>
                        </value>
                        <value id="mini">
                            <code>mini</code>
                            <rank>20</rank>
                        </value>
                        <value id="micro">
                            <code>micro</code>
                            <rank>30</rank>
                        </value>
                        <value id="nano">
                            <code>nano</code>
                            <rank>40</rank>
                        </value>
                        <value id="esim">
                            <code>esim</code>
                            <rank>50</rank>
                        </value>
                    </values>
                    <is_null_allowed>true</is_null_allowed>
                    <default_value/>
                    <display_style>list</display_style>
                </field>
                <field id="simcard1_id" xsi:type="AttributeExternalKey" _delta="define">
                    <sql>simcard1_id</sql>
                    <target_class>SimCard</target_class>
                    <filter><![CDATA[SELECT SimCard AS c WHERE c.org_id = :this->org_id AND
                               (IF (:this->simcard_format = 'full', c.format IN ('full', 'full_to_micro', 'full_to_nano'),
                                    (IF (:this->simcard_format = 'micro', c.format IN ('micro', 'full_to_micro'),
                                         (IF (:this->simcard_format = 'nano', c.format IN ('nano', 'full_to_nano', 'micro_to_nano'),
                                              c.format = :this->simcard_format
                                         ))
                                    ))
                               ))]]>
                    </filter>
                    <dependencies>
                        <attribute id="org_id"/>
                        <attribute id="simcard_format"/>
                    </dependencies>
                    <is_null_allowed>true</is_null_allowed>
                    <allow_target_creation>true</allow_target_creation>
                    <on_target_delete>DEL_AUTO</on_target_delete>
                </field>
                <field id="simcard1_name" xsi:type="AttributeExternalField" _delta="define">
                    <extkey_attcode>simcard1_id</extkey_attcode>
                    <target_attcode>name</target_attcode>
                </field>
                <field id="simcard2_id" xsi:type="AttributeExternalKey" _delta="define">
                    <sql>simcard2_id</sql>
                    <target_class>SimCard</target_class>
                    <filter><![CDATA[SELECT SimCard AS c WHERE c.org_id = :this->org_id AND c.id != :this->simcard1_id AND
                               (IF (:this->simcard_format = 'full', c.format IN ('full', 'full_to_micro', 'full_to_nano'),
                                    (IF (:this->simcard_format = 'micro', c.format IN ('micro', 'full_to_micro'),
                                         (IF (:this->simcard_format = 'nano', c.format IN ('nano', 'full_to_nano', 'micro_to_nano'),
                                              c.format = :this->simcard_format
                                         ))
                                    ))
                               ))]]>
                    </filter>
                    <dependencies>
                        <attribute id="org_id"/>
                        <attribute id="simcard_format"/>
                    </dependencies>
                    <is_null_allowed>true</is_null_allowed>
                    <allow_target_creation>true</allow_target_creation>
                    <on_target_delete>DEL_AUTO</on_target_delete>
                </field>
                <field id="simcard2_name" xsi:type="AttributeExternalField" _delta="define">
                    <extkey_attcode>simcard2_id</extkey_attcode>
                    <target_attcode>name</target_attcode>
                </field>
            </fields>
            <presentation>
                <details _delta="redefine">
                    <items>
                        <item id="col:col1">
                            <rank>10</rank>
                            <items>
                                <item id="fieldset:TelephonyCI:baseinfo">
                                    <rank>10</rank>
                                    <items>
                                        <item id="name">
                                            <rank>10</rank>
                                        </item>
                                        <item id="org_id">
                                            <rank>20</rank>
                                        </item>
                                        <item id="status">
                                            <rank>30</rank>
                                        </item>
                                        <item id="phonenumber_id">
                                            <rank>40</rank>
                                        </item>
                                        <item id="business_criticity">
                                            <rank>50</rank>
                                        </item>
                                        <item id="location_id">
                                            <rank>60</rank>
                                        </item>
                                        <item id="description">
                                            <rank>70</rank>
                                        </item>
                                    </items>
                                </item>
                                <item id="fieldset:TelephonyCI:hwinfo">
                                    <rank>20</rank>
                                    <items>
                                        <item id="brand_id">
                                            <rank>10</rank>
                                        </item>
                                        <item id="model_id">
                                            <rank>20</rank>
                                        </item>
                                        <item id="serialnumber">
                                            <rank>30</rank>
                                        </item>
                                        <item id="asset_number">
                                            <rank>40</rank>
                                        </item>
                                        <item id="macaddress">
                                            <rank>50</rank>
                                        </item>
                                    </items>
                                </item>
                            </items>
                        </item>
                        <item id="col:col2">
                            <rank>20</rank>
                            <items>
                                <item id="fieldset:TelephonyCI:date">
                                    <rank>10</rank>
                                    <items>
                                        <item id="move2production">
                                            <rank>10</rank>
                                        </item>
                                        <item id="purchase_date">
                                            <rank>20</rank>
                                        </item>
                                        <item id="end_of_warranty">
                                            <rank>30</rank>
                                        </item>
                                    </items>
                                </item>
                                <item id="fieldset:TelephonyCI:techinfo">
                                    <rank>20</rank>
                                    <items>
                                        <item id="imei">
                                            <rank>10</rank>
                                        </item>
                                        <item id="hw_pin">
                                            <rank>20</rank>
                                        </item>
                                        <item id="simcard_format">
                                            <rank>30</rank>
                                        </item>
                                        <item id="simcard1_id">
                                            <rank>40</rank>
                                        </item>
                                        <item id="simcard2_id">
                                            <rank>50</rank>
                                        </item>
                                        <item id="ipaddress_id">
                                            <rank>60</rank>
                                        </item>
                                    </items>
                                </item>
                            </items>
                        </item>
                        <item id="contacts_list">
                            <rank>30</rank>
                        </item>
                        <item id="documents_list">
                            <rank>30</rank>
                        </item>
                    </items>
                </details>
                <search _delta="must_exist">
                    <items>
                        <item id="phonenumber" _delta="delete"/>
                        <item id="phonenumber_id" _delta="define">
                            <rank>80</rank>
                        </item>
                    </items>
                </search>
                <list _delta="must_exist">
                    <items>
                        <item id="phonenumber" _delta="delete"/>
                        <item id="phonenumber_id" _delta="define">
                            <rank>60</rank>
                        </item>
                    </items>
                </list>
                <summary _delta="must_exist">
                    <items>
                        <item id="phonenumber" _delta="delete"/>
                        <item id="phonenumber_id" _delta="define">
                            <rank>80</rank>
                        </item>
                    </items>
                </summary>
            </presentation>
        </class>
        <class id="IPPhone" _delta="must_exist">
            <presentation>
                <details _delta="redefine">
                    <items>
                        <item id="col:col1">
                            <rank>10</rank>
                            <items>
                                <item id="fieldset:TelephonyCI:baseinfo">
                                    <rank>10</rank>
                                    <items>
                                        <item id="name">
                                            <rank>10</rank>
                                        </item>
                                        <item id="org_id">
                                            <rank>20</rank>
                                        </item>
                                        <item id="status">
                                            <rank>30</rank>
                                        </item>
                                        <item id="phonenumber_id">
                                            <rank>40</rank>
                                        </item>
                                        <item id="business_criticity">
                                            <rank>50</rank>
                                        </item>
                                        <item id="location_id">
                                            <rank>60</rank>
                                        </item>
                                        <item id="description">
                                            <rank>70</rank>
                                        </item>
                                    </items>
                                </item>
                                <item id="fieldset:TelephonyCI:hwinfo">
                                    <rank>20</rank>
                                    <items>
                                        <item id="brand_id">
                                            <rank>10</rank>
                                        </item>
                                        <item id="model_id">
                                            <rank>20</rank>
                                        </item>
                                        <item id="serialnumber">
                                            <rank>30</rank>
                                        </item>
                                        <item id="asset_number">
                                            <rank>40</rank>
                                        </item>
                                        <item id="macaddress">
                                            <rank>50</rank>
                                        </item>
                                    </items>
                                </item>
                            </items>
                        </item>
                        <item id="col:col2">
                            <rank>20</rank>
                            <items>
                                <item id="fieldset:TelephonyCI:date">
                                    <rank>10</rank>
                                    <items>
                                        <item id="move2production">
                                            <rank>10</rank>
                                        </item>
                                        <item id="purchase_date">
                                            <rank>20</rank>
                                        </item>
                                        <item id="end_of_warranty">
                                            <rank>30</rank>
                                        </item>
                                    </items>
                                </item>
                                <item id="fieldset:TelephonyCI:techinfo">
                                    <rank>20</rank>
                                    <items>
                                        <item id="ipaddress_id">
                                            <rank>10</rank>
                                        </item>
                                    </items>
                                </item>
                            </items>
                        </item>
                        <item id="contacts_list">
                            <rank>30</rank>
                        </item>
                        <item id="documents_list">
                            <rank>30</rank>
                        </item>
                    </items>
                </details>
                <search _delta="must_exist">
                    <items>
                        <item id="phonenumber" _delta="delete"/>
                        <item id="phonenumber_id" _delta="define">
                            <rank>80</rank>
                        </item>
                    </items>
                </search>
                <list _delta="must_exist">
                    <items>
                        <item id="phonenumber" _delta="delete"/>
                        <item id="phonenumber_id" _delta="define">
                            <rank>60</rank>
                        </item>
                    </items>
                </list>
                <summary _delta="must_exist">
                    <items>
                        <item id="phonenumber" _delta="delete"/>
                        <item id="phonenumber_id" _delta="define">
                            <rank>80</rank>
                        </item>
                    </items>
                </summary>
            </presentation>
        </class>
        <class id="Tablet" _delta="must_exist">
            <fields>
                <field id="simcard_format" xsi:type="AttributeEnum" _delta="define">
                    <sql>simcard_format</sql>
                    <sort_type>rank</sort_type>
                    <values>
                        <value id="full">
                            <code>full</code>
                            <rank>10</rank>
                        </value>
                        <value id="mini">
                            <code>mini</code>
                            <rank>20</rank>
                        </value>
                        <value id="micro">
                            <code>micro</code>
                            <rank>30</rank>
                        </value>
                        <value id="nano">
                            <code>nano</code>
                            <rank>40</rank>
                        </value>
                        <value id="esim">
                            <code>esim</code>
                            <rank>50</rank>
                        </value>
                    </values>
                    <is_null_allowed>true</is_null_allowed>
                    <default_value/>
                    <display_style>list</display_style>
                </field>
                <field id="simcard_id" xsi:type="AttributeExternalKey" _delta="define">
                    <sql>simcard_id</sql>
                    <target_class>SimCard</target_class>
                    <filter><![CDATA[SELECT SimCard AS c WHERE c.org_id = :this->org_id AND
                               (IF (:this->simcard_format = 'full', c.format IN ('full', 'full_to_micro', 'full_to_nano'),
                                    (IF (:this->simcard_format = 'micro', c.format IN ('micro', 'full_to_micro'),
                                         (IF (:this->simcard_format = 'nano', c.format IN ('nano', 'full_to_nano', 'micro_to_nano'),
                                              c.format = :this->simcard_format
                                         ))
                                    ))
                               ))]]>
                    </filter>
                    <dependencies>
                        <attribute id="org_id"/>
                        <attribute id="simcard_format"/>
                    </dependencies>
                    <is_null_allowed>true</is_null_allowed>
                    <allow_target_creation>true</allow_target_creation>
                    <on_target_delete>DEL_AUTO</on_target_delete>
                </field>
                <field id="simcard_name" xsi:type="AttributeExternalField" _delta="define">
                    <extkey_attcode>simcard_id</extkey_attcode>
                    <target_attcode>name</target_attcode>
                </field>
            </fields>
            <presentation>
                <details _delta="redefine">
                    <items>
                        <item id="col:col1">
                            <rank>10</rank>
                            <items>
                                <item id="fieldset:Tablet:baseinfo">
                                    <rank>10</rank>
                                    <items>
                                        <item id="name">
                                            <rank>10</rank>
                                        </item>
                                        <item id="org_id">
                                            <rank>20</rank>
                                        </item>
                                        <item id="status">
                                            <rank>30</rank>
                                        </item>
                                        <item id="business_criticity">
                                            <rank>50</rank>
                                        </item>
                                        <item id="location_id">
                                            <rank>60</rank>
                                        </item>
                                        <item id="description">
                                            <rank>70</rank>
                                        </item>
                                    </items>
                                </item>
                                <item id="fieldset:Tablet:hwinfo">
                                    <rank>20</rank>
                                    <items>
                                        <item id="brand_id">
                                            <rank>10</rank>
                                        </item>
                                        <item id="model_id">
                                            <rank>20</rank>
                                        </item>
                                        <item id="serialnumber">
                                            <rank>30</rank>
                                        </item>
                                        <item id="asset_number">
                                            <rank>40</rank>
                                        </item>
                                        <item id="macaddress">
                                            <rank>50</rank>
                                        </item>
                                    </items>
                                </item>
                            </items>
                        </item>
                        <item id="col:col2">
                            <rank>20</rank>
                            <items>
                                <item id="fieldset:Tablet:date">
                                    <rank>10</rank>
                                    <items>
                                        <item id="move2production">
                                            <rank>10</rank>
                                        </item>
                                        <item id="purchase_date">
                                            <rank>20</rank>
                                        </item>
                                        <item id="end_of_warranty">
                                            <rank>30</rank>
                                        </item>
                                    </items>
                                </item>
                                <item id="fieldset:Tablet:techinfo">
                                    <rank>20</rank>
                                    <items>
                                        <item id="simcard_format">
                                            <rank>10</rank>
                                        </item>
                                        <item id="simcard_id">
                                            <rank>20</rank>
                                        </item>
                                        <item id="ipaddress_id">
                                            <rank>30</rank>
                                        </item>
                                    </items>
                                </item>
                            </items>
                        </item>
                        <item id="contacts_list">
                            <rank>30</rank>
                        </item>
                        <item id="documents_list">
                            <rank>30</rank>
                        </item>
                    </items>
                </details>
            </presentation>
        </class>
        <class id="PC" _delta="must_exist">
            <fields>
                <field id="simcard_format" xsi:type="AttributeEnum" _delta="define">
                    <sql>simcard_format</sql>
                    <sort_type>rank</sort_type>
                    <values>
                        <value id="full">
                            <code>full</code>
                            <rank>10</rank>
                        </value>
                        <value id="mini">
                            <code>mini</code>
                            <rank>20</rank>
                        </value>
                        <value id="micro">
                            <code>micro</code>
                            <rank>30</rank>
                        </value>
                        <value id="nano">
                            <code>nano</code>
                            <rank>40</rank>
                        </value>
                        <value id="esim">
                            <code>esim</code>
                            <rank>50</rank>
                        </value>
                    </values>
                    <is_null_allowed>true</is_null_allowed>
                    <default_value/>
                    <display_style>list</display_style>
                </field>
                <field id="simcard_id" xsi:type="AttributeExternalKey" _delta="define">
                    <sql>simcard_id</sql>
                    <target_class>SimCard</target_class>
                    <filter><![CDATA[SELECT SimCard AS c WHERE c.org_id = :this->org_id AND
                               (IF (:this->simcard_format = 'full', c.format IN ('full', 'full_to_micro', 'full_to_nano'),
                                    (IF (:this->simcard_format = 'micro', c.format IN ('micro', 'full_to_micro'),
                                         (IF (:this->simcard_format = 'nano', c.format IN ('nano', 'full_to_nano', 'micro_to_nano'),
                                              c.format = :this->simcard_format
                                         ))
                                    ))
                               ))]]>
                    </filter>
                    <dependencies>
                        <attribute id="org_id"/>
                        <attribute id="simcard_format"/>
                    </dependencies>
                    <is_null_allowed>true</is_null_allowed>
                    <allow_target_creation>true</allow_target_creation>
                    <on_target_delete>DEL_AUTO</on_target_delete>
                </field>
                <field id="simcard_name" xsi:type="AttributeExternalField" _delta="define">
                    <extkey_attcode>simcard_id</extkey_attcode>
                    <target_attcode>name</target_attcode>
                </field>
            </fields>
            <presentation>
                <details _delta="must_exist">
                    <items>
                        <item id="col:col2" _delta="must_exist">
                            <items>
                                <item id="fieldset:Server:otherinfo" _delta="must_exist">
                                    <items>
                                        <item id="simcard_format" _delta="define">
                                            <rank>5</rank>
                                        </item>
                                        <item id="simcard_id" _delta="define">
                                            <rank>6</rank>
                                        </item>
                                    </items>
                                </item>
                            </items>
                        </item>
                    </items>
                </details>
            </presentation>
        </class>
        <class id="NetworkDevice" _delta="must_exist">
            <fields>
                <field id="simcard_format" xsi:type="AttributeEnum" _delta="define">
                    <sql>simcard_format</sql>
                    <sort_type>rank</sort_type>
                    <values>
                        <value id="full">
                            <code>full</code>
                            <rank>10</rank>
                        </value>
                        <value id="mini">
                            <code>mini</code>
                            <rank>20</rank>
                        </value>
                        <value id="micro">
                            <code>micro</code>
                            <rank>30</rank>
                        </value>
                        <value id="nano">
                            <code>nano</code>
                            <rank>40</rank>
                        </value>
                        <value id="esim">
                            <code>esim</code>
                            <rank>50</rank>
                        </value>
                    </values>
                    <is_null_allowed>true</is_null_allowed>
                    <default_value/>
                    <display_style>list</display_style>
                </field>
                <field id="simcard_id" xsi:type="AttributeExternalKey" _delta="define">
                    <sql>simcard_id</sql>
                    <target_class>SimCard</target_class>
                    <filter><![CDATA[SELECT SimCard AS c WHERE c.org_id = :this->org_id AND
                               (IF (:this->simcard_format = 'full', c.format IN ('full', 'full_to_micro', 'full_to_nano'),
                                    (IF (:this->simcard_format = 'micro', c.format IN ('micro', 'full_to_micro'),
                                         (IF (:this->simcard_format = 'nano', c.format IN ('nano', 'full_to_nano', 'micro_to_nano'),
                                              c.format = :this->simcard_format
                                         ))
                                    ))
                               ))]]>
                    </filter>
                    <dependencies>
                        <attribute id="org_id"/>
                        <attribute id="simcard_format"/>
                    </dependencies>
                    <is_null_allowed>true</is_null_allowed>
                    <allow_target_creation>true</allow_target_creation>
                    <on_target_delete>DEL_AUTO</on_target_delete>
                </field>
                <field id="simcard_name" xsi:type="AttributeExternalField" _delta="define">
                    <extkey_attcode>simcard_id</extkey_attcode>
                    <target_attcode>name</target_attcode>
                </field>
            </fields>
            <presentation>
                <details _delta="must_exist">
                    <items>
                        <item id="col:col2" _delta="must_exist">
                            <items>
                                <item id="fieldset:Server:otherinfo" _delta="must_exist">
                                    <items>
                                        <item id="simcard_format" _delta="define">
                                            <rank>5</rank>
                                        </item>
                                        <item id="simcard_id" _delta="define">
                                            <rank>6</rank>
                                        </item>
                                    </items>
                                </item>
                            </items>
                        </item>
                    </items>
                </details>
            </presentation>
        </class>
        <class id="Peripheral" _delta="must_exist">
            <fields>
                <field id="simcard_format" xsi:type="AttributeEnum" _delta="define">
                    <sql>simcard_format</sql>
                    <sort_type>rank</sort_type>
                    <values>
                        <value id="full">
                            <code>full</code>
                            <rank>10</rank>
                        </value>
                        <value id="mini">
                            <code>mini</code>
                            <rank>20</rank>
                        </value>
                        <value id="micro">
                            <code>micro</code>
                            <rank>30</rank>
                        </value>
                        <value id="nano">
                            <code>nano</code>
                            <rank>40</rank>
                        </value>
                        <value id="esim">
                            <code>esim</code>
                            <rank>50</rank>
                        </value>
                    </values>
                    <is_null_allowed>true</is_null_allowed>
                    <default_value/>
                    <display_style>list</display_style>
                </field>
                <field id="simcard_id" xsi:type="AttributeExternalKey" _delta="define">
                    <sql>simcard_id</sql>
                    <target_class>SimCard</target_class>
                    <filter><![CDATA[SELECT SimCard AS c WHERE c.org_id = :this->org_id AND
                               (IF (:this->simcard_format = 'full', c.format IN ('full', 'full_to_micro', 'full_to_nano'),
                                    (IF (:this->simcard_format = 'micro', c.format IN ('micro', 'full_to_micro'),
                                         (IF (:this->simcard_format = 'nano', c.format IN ('nano', 'full_to_nano', 'micro_to_nano'),
                                              c.format = :this->simcard_format
                                         ))
                                    ))
                               ))]]>
                    </filter>
                    <dependencies>
                        <attribute id="org_id"/>
                        <attribute id="simcard_format"/>
                    </dependencies>
                    <is_null_allowed>true</is_null_allowed>
                    <allow_target_creation>true</allow_target_creation>
                    <on_target_delete>DEL_AUTO</on_target_delete>
                </field>
                <field id="simcard_name" xsi:type="AttributeExternalField" _delta="define">
                    <extkey_attcode>simcard_id</extkey_attcode>
                    <target_attcode>name</target_attcode>
                </field>
            </fields>
            <presentation>
                <details _delta="redefine">
                    <items>
                        <item id="col:col1">
                            <rank>10</rank>
                            <items>
                                <item id="fieldset:Peripheral:baseinfo">
                                    <rank>10</rank>
                                    <items>
                                        <item id="name">
                                            <rank>10</rank>
                                        </item>
                                        <item id="org_id">
                                            <rank>20</rank>
                                        </item>
                                        <item id="status">
                                            <rank>30</rank>
                                        </item>
                                        <item id="business_criticity">
                                            <rank>50</rank>
                                        </item>
                                        <item id="location_id">
                                            <rank>60</rank>
                                        </item>
                                        <item id="description">
                                            <rank>70</rank>
                                        </item>
                                    </items>
                                </item>
                                <item id="fieldset:Peripheral:hwinfo">
                                    <rank>20</rank>
                                    <items>
                                        <item id="brand_id">
                                            <rank>10</rank>
                                        </item>
                                        <item id="model_id">
                                            <rank>20</rank>
                                        </item>
                                        <item id="serialnumber">
                                            <rank>30</rank>
                                        </item>
                                        <item id="asset_number">
                                            <rank>40</rank>
                                        </item>
                                        <item id="macaddress">
                                            <rank>50</rank>
                                        </item>
                                    </items>
                                </item>
                            </items>
                        </item>
                        <item id="col:col2">
                            <rank>20</rank>
                            <items>
                                <item id="fieldset:Peripheral:date">
                                    <rank>10</rank>
                                    <items>
                                        <item id="move2production">
                                            <rank>10</rank>
                                        </item>
                                        <item id="purchase_date">
                                            <rank>20</rank>
                                        </item>
                                        <item id="end_of_warranty">
                                            <rank>30</rank>
                                        </item>
                                    </items>
                                </item>
                                <item id="fieldset:Peripheral:techinfo">
                                    <rank>20</rank>
                                    <items>
                                        <item id="simcard_format">
                                            <rank>10</rank>
                                        </item>
                                        <item id="simcard_id">
                                            <rank>20</rank>
                                        </item>
                                        <item id="ipaddress_id">
                                            <rank>30</rank>
                                        </item>
                                    </items>
                                </item>
                            </items>
                        </item>
                        <item id="contacts_list">
                            <rank>30</rank>
                        </item>
                        <item id="documents_list">
                            <rank>30</rank>
                        </item>
                    </items>
                </details>
            </presentation>
        </class>
        <class id="PhysicalDevice" _delta="must_exist">
            <event_listeners>
                <event_listener id="OnPhysicalDeviceAfterWriteRequestedByEndUsersDevicesExtendedMgmt" _delta="define">
                    <event>EVENT_DB_AFTER_WRITE</event>
                    <callback>OnPhysicalDeviceAfterWriteRequestedByEndUsersDevicesExtendedMgmt</callback>
                    <rank>100</rank>
                </event_listener>
                <event_listener id="OnPhysicalDeviceAfterDeleteRequestedByEndUsersDevicesExtendedMgmt" _delta="define">
                    <event>EVENT_DB_AFTER_DELETE</event>
                    <callback>OnPhysicalDeviceAfterDeleteRequestedByEndUsersDevicesExtendedMgmt</callback>
                    <rank>100</rank>
                </event_listener>
            </event_listeners>
            <methods>
                <method id="SetPhysicalDeviceOnSimCard" _delta="define">
                    <comment/>
                    <static>false</static>
                    <access>private</access>
                    <type>custom</type>
                    <code><![CDATA[    public function SetPhysicalDeviceOnSimCard($iSimCardId)
    {
			if ($iSimCardId > 0) {
				$sOQL = "SELECT SimCard AS s WHERE s.id = :id";
				$oSimCardSet = new CMDBObjectSet(DBObjectSearch::FromOQL($sOQL), array(), array('id' => $iSimCardId));
				if ($oSimCard = $oSimCardSet->Fetch()) {
					$oSimCard->Set('physicaldevice_id', $this->GetKey());
					$oSimCard->DBUpdate();
				}
			}
    }]]></code>
                </method>
                <method id="ResetPhysicalDeviceOnSimCard" _delta="define">
                    <comment/>
                    <static>false</static>
                    <access>private</access>
                    <type>custom</type>
                    <code><![CDATA[    public function ResetPhysicalDeviceOnSimCard($iSimCardId)
    {
			if ($iSimCardId > 0) {
				$sOQL = "SELECT SimCard AS s WHERE s.id = :id";
       			$oSimCardSet = new CMDBObjectSet(DBObjectSearch::FromOQL($sOQL), array(), array('id' => $iSimCardId));
				if ($oSimCard = $oSimCardSet->Fetch()) {
				    if ($oSimCard->Get('physicaldevice_id') == $this->GetKey()) {
					    $oSimCard->Set('physicaldevice_id', 0);
					    $oSimCard->DBUpdate();
					}
				}
			}
    }]]></code>
                </method>
                <method id="OnPhysicalDeviceAfterWriteRequestedByEndUsersDevicesExtendedMgmt" _delta="define">
                    <comment/>
                    <static>false</static>
                    <access>public</access>
                    <type>EventListener</type>
                    <code><![CDATA[    public function OnPhysicalDeviceAfterWriteRequestedByEndUsersDevicesExtendedMgmt(Combodo\iTop\Service\Events\EventData $oEventData)
    {
        $sClass = get_class($this);
        if ($sClass == 'MobilePhone') {
            // Process the case of mobile phones first
            $aEventData = $oEventData->GetEventData();
            if ($aEventData['is_new']) {
                // We are in the AfterInsert situation
                $this->SetPhysicalDeviceOnSimCard($this->Get('simcard1_id'));
                $this->SetPhysicalDeviceOnSimCard($this->Get('simcard2_id'));
            } else {
                // We are in the AfterUpdate situation
                $aChanges = $this->ListPreviousValuesForUpdatedAttributes();
                if (array_key_exists('simcard1_id', $aChanges)) {
                    $this->ResetPhysicalDeviceOnSimCard($aChanges['simcard1_id']);
                    $this->SetPhysicalDeviceOnSimCard($this->Get('simcard1_id'));
                }
                if (array_key_exists('simcard2_id', $aChanges)) {
                    $this->ResetPhysicalDeviceOnSimCard($aChanges['simcard2_id']);
                    $this->SetPhysicalDeviceOnSimCard($this->Get('simcard2_id'));
                }
            }
        } else {
            $aDevicesWithSimCard = explode(',', DEVICES_WITH_SIMCARD);
            if (in_array(get_class($this), $aDevicesWithSimCard) && in_array('simcard_id', MetaModel::GetAttributesList($sClass))) {
                // Process the other CIs with sim cards next
                $aEventData = $oEventData->GetEventData();
                if ($aEventData['is_new']) {
                    // We are in the AfterInsert situation
                    $this->SetPhysicalDeviceOnSimCard($this->Get('simcard_id'));
                } else {
                    // We are in the AfterUpdate situation
                    $aChanges = $this->ListPreviousValuesForUpdatedAttributes();
                    if (array_key_exists('simcard_id', $aChanges)) {
                        $this->ResetPhysicalDeviceOnSimCard($aChanges['simcard_id']);
                        $this->SetPhysicalDeviceOnSimCard($this->Get('simcard_id'));
                    }
                }
            }
        }
    }]]></code>
                </method>
                <method id="OnPhysicalDeviceAfterDeleteRequestedByEndUsersDevicesExtendedMgmt" _delta="define">
                    <comment/>
                    <static>false</static>
                    <access>public</access>
                    <type>EventListener</type>
                    <code><![CDATA[    public function OnPhysicalDeviceAfterDeleteRequestedByEndUsersDevicesExtendedMgmt(Combodo\iTop\Service\Events\EventData $oEventData)
    {
        $sClass = get_class($this);
        if ($sClass == 'MobilePhone') {
            // Process the case of mobile phones first
 		    $this->ResetPhysicalDeviceOnSimCard($this->Get('simcard1_id'));
		    $this->ResetPhysicalDeviceOnSimCard($this->Get('simcard2_id'));
		} else {
            $aDevicesWithSimCard = explode(',', DEVICES_WITH_SIMCARD);
            if (in_array(get_class($this), $aDevicesWithSimCard) && in_array('simcard_id', MetaModel::GetAttributesList(get_class($this)))) {
                // Process the other CIs with sim cards next
		        $this->ResetPhysicalDeviceOnSimCard($this->Get('simcard_id'));
		    }
		}
    }]]></code>
                </method>
            </methods>
        </class>
    </classes>
    <menus>
        <menu id="ConfigManagementOverview" _delta="must_exist">
            <definition>
                <cells>
                    <cell id="2" _delta="must_exist">
                        <dashlets>
                            <dashlet id="teemip_101" xsi:type="DashletBadge" _delta="define">
                                <rank>101</rank>
                                <class>SimCard</class>
                            </dashlet>
                        </dashlets>
                    </cell>
                </cells>
            </definition>
        </menu>
        <menu id="TelephonySpace" _delta="must_exist">
            <definition>
                <cells>
                    <cell id="teemip-200" _delta="define">
                        <rank>20</rank>
                        <dashlets>
                            <dashlet id="teemip-210" xsi:type="DashletHeaderStatic">
                                <rank>10</rank>
                                <title>Menu:TelefonySpace:Devices</title>
                                <icon>teemip-phone-number-mgmt/asset/img/icons8-internet-folder-48.png</icon>
                            </dashlet>
                            <dashlet id="teemip-220" xsi:type="DashletBadge">
                                <rank>20</rank>
                                <class>Phone</class>
                            </dashlet>
                            <dashlet id="teemip-230" xsi:type="DashletBadge">
                                <rank>30</rank>
                                <class>IPPhone</class>
                            </dashlet>
                            <dashlet id="teemip-240" xsi:type="DashletBadge">
                                <rank>40</rank>
                                <class>MobilePhone</class>
                            </dashlet>
                            <dashlet id="teemip-250" xsi:type="DashletBadge">
                                <rank>50</rank>
                                <class>SimCard</class>
                            </dashlet>
                        </dashlets>
                    </cell>
                </cells>
            </definition>
        </menu>
    </menus>
</itop_design>
